<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚¿ãƒ« v6</title>
    <style>
        /* --- åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; color: #333; }
        
        /* å…¨ã‚³ãƒ³ãƒ†ãƒŠã‚’æœ€åˆã¯éš ã™ï¼ˆãƒãƒ©ã¤ãé˜²æ­¢ï¼‰ */
        #auth-container, #profile-view, #app-container { display: none; max-width: 500px; margin: 30px auto; background: #fff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        #app-container { max-width: 100%; margin: 0; border-radius: 0; min-height: 100vh; display: none; flex-direction: column; }
        
        .hidden { display: none !important; }
        .tab-menu { display: flex; background: #eee; }
        .tab-menu div { flex: 1; text-align: center; padding: 15px 0; cursor: pointer; font-weight: bold; color: #888; }
        .tab-menu div.active { background: #fff; color: #2196F3; border-bottom: 3px solid #2196F3; }
        .form-area { padding: 30px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; margin-bottom: 5px; color: #666; font-weight: bold; }
        .input-group input, .input-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .action-btn { width: 100%; padding: 12px; background: #2196F3; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; }
        
        header { background: #2c3e50; color: #fff; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .hamburger-btn { font-size: 24px; cursor: pointer; }
        
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        #sidebar { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background: #fff; box-shadow: 2px 0 10px rgba(0,0,0,0.2); transition: 0.3s ease; z-index: 1000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        #sidebar.open { left: 0; }
        .sidebar-close { text-align: right; font-size: 24px; cursor: pointer; color: #999; margin-bottom: 10px; }
        .nav-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: bold; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .nav-item:hover { background: #f9f9f9; }
        .nav-badge { background: #ff5252; color: white; border-radius: 10px; padding: 2px 8px; font-size: 10px; }
        
        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º */
        .user-icon { width: 80px; height: 80px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 40px; margin: 0 auto 10px; overflow: hidden; border: 2px solid #2196F3; }
        .user-icon img { width: 100%; height: 100%; object-fit: cover; }
        .small-icon { width: 50px; height: 50px; font-size: 24px; }

        .user-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; padding: 15px; }
        .user-card { background: #fff; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; text-decoration: none; color: inherit; transition: 0.2s; }
        
        .stats { display: flex; justify-content: space-around; margin: 20px 0; background: #f9f9f9; padding: 10px; border-radius: 10px; }
        .stats b { display: block; font-size: 18px; color: #2196F3; }

        /* é€šçŸ¥ã‚¢ã‚¤ãƒ†ãƒ  */
        .notif-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; line-height: 1.4; }
        .notif-time { color: #999; font-size: 11px; margin-top: 4px; }
    </style>
</head>
<body>

    <div id="profile-view">
        <div class="form-area" style="text-align:center;">
            <div class="user-icon" id="view-icon">ğŸ‘¤</div>
            <h2 id="view-name">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</h2>
            <button id="btn-follow" class="action-btn" style="width: auto; padding: 8px 20px; margin-bottom: 10px;">ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹</button>
            <div id="view-bio" style="background:#f0f4f8; padding:15px; border-radius:10px; text-align:left; font-size:14px; margin:15px 0; min-height:40px; white-space: pre-wrap;"></div>
            <div class="stats">
                <div>ğŸ‘€ <b id="view-count">0</b></div>
                <div>ğŸ’° <b id="view-score">0</b></div>
                <div>ğŸ‘¥ <b id="view-followers">0</b></div>
            </div>
            <div style="display: flex; justify-content: center; gap: 5px; margin-bottom: 15px;">
                <input type="number" id="tip-amount" placeholder="æ•°" style="width: 70px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                <button id="btn-tip" class="action-btn" style="background:#FF9800; width: auto; padding: 10px 20px;">pt é€ã‚‹</button>
            </div>
            <a href="#" style="display:block; color:#2196F3; font-size:14px;" onclick="location.hash=''; location.reload();">é–‰ã˜ã‚‹ / ãƒ›ãƒ¼ãƒ ã¸</a>
        </div>
    </div>

    <div id="auth-container">
        <div class="tab-menu">
            <div id="tab-login" class="active" onclick="switchTab('login')">ãƒ­ã‚°ã‚¤ãƒ³</div>
            <div id="tab-register" onclick="switchTab('register')">æ–°è¦ä½œæˆ</div>
        </div>
        <div id="form-login" class="form-area">
            <div class="input-group"><label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label><input type="text" id="login-username"></div>
            <div class="input-group"><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="login-password"></div>
            <button class="action-btn" id="btn-do-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
        <div id="form-register" class="form-area hidden">
            <div class="input-group"><label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label><input type="text" id="reg-username"></div>
            <div class="input-group"><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="reg-password"></div>
            <button class="action-btn" id="btn-do-register" style="background:#34495e;">ç™»éŒ²å®Œäº†</button>
        </div>
    </div>

    <div id="app-container">
        <header>
            <div class="hamburger-btn" onclick="toggleSidebar()">â˜°</div>
            <div id="page-title">ãƒ›ãƒ¼ãƒ </div>
            <div style="width:24px;"></div>
        </header>

        <nav id="sidebar">
            <div class="sidebar-close" onclick="toggleSidebar()">Ã—</div>
            <div class="user-icon" id="side-icon" style="border:none;">ğŸ‘¤</div>
            <div style="text-align:center; font-size:14px; margin-bottom:20px; font-weight:bold;"><span id="disp-name"></span></div>
            
            <div class="nav-item" onclick="showSection('home')">ğŸ  ãƒ›ãƒ¼ãƒ </div>
            <div class="nav-item" onclick="showSection('members')">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</div>
            <div class="nav-item" onclick="showSection('settings')">âš™ï¸ ãƒ—ãƒ­ãƒ•è¨­å®š</div>
            <div class="nav-item" onclick="showSection('ff')">â¤ï¸ FFä¸€è¦§</div>
            <div class="nav-item" onclick="showSection('notifications')">
                ğŸ”” é€šçŸ¥ <span id="notif-badge" class="nav-badge hidden">!</span>
            </div>
            
            <button id="btn-logout" style="width:100%; padding:10px; background:#eee; border:none; border-radius:5px; margin-top:30px; cursor:pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </nav>

        <main id="section-home" class="form-area" style="text-align:center;">
            <h1>ã“ã‚“ã«ã¡ã¯ï¼</h1>
            <div class="stats" style="background:white; border:1px solid #eee;">
                <div>ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ<b id="home-score">0</b></div>
            </div>
            <p style="font-size:12px; color:#666;">ã‚ãªãŸã®ãƒã‚¤ãƒšãƒ¼ã‚¸URL:</p>
            <code id="share-url" style="background:#f0f0f0; padding:10px; font-size:10px; display:block; word-break:break-all;"></code>
        </main>

        <main id="section-members" class="hidden">
            <div id="user-list-area" class="user-list"></div>
        </main>

        <main id="section-settings" class="hidden form-area">
            <h3>ãƒ—ãƒ­ãƒ•è¨­å®š</h3>
            <div class="user-icon" id="settings-icon-disp" onclick="changeIcon()" style="cursor:pointer; position:relative;">
                ğŸ‘¤
                <div style="position:absolute; bottom:0; background:rgba(0,0,0,0.5); color:white; font-size:10px; width:100%;">å¤‰æ›´</div>
            </div>
            <div class="input-group">
                <label>è‡ªå·±ç´¹ä»‹ (100æ–‡å­—ä»¥å†…)</label>
                <textarea id="settings-bio-input" rows="4" placeholder="è‡ªå·±ç´¹ä»‹ã‚’æ›¸ã„ã¦ã¿ã‚ˆã†"></textarea>
            </div>
            <button class="action-btn" onclick="saveBio()">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜</button>
        </main>

        <main id="section-ff" class="hidden">
            <div class="tab-menu" style="background:none; border-bottom:1px solid #eee;">
                <div id="tab-ff-follower" class="active" onclick="toggleFF('follower')">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</div>
                <div id="tab-ff-following" onclick="toggleFF('following')">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</div>
            </div>
            <div id="ff-list-area" class="user-list"></div>
        </main>

        <main id="section-notifications" class="hidden">
            <div id="notif-list-area"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, update, increment, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCwhHspaG94goiCIjVj3h-Un5pBK3JTjMU",
            authDomain: "soulkin-aa3b7.firebaseapp.com",
            databaseURL: "https://soulkin-aa3b7-default-rtdb.firebaseio.com",
            projectId: "soulkin-aa3b7",
            storageBucket: "soulkin-aa3b7.firebasestorage.app",
            messagingSenderId: "358331064206",
            appId: "1:358331064206:web:d7760ea0919259418a4edf"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- åŸºæœ¬åˆ¶å¾¡ ---
        window.switchTab = (t) => {
            document.getElementById('form-login').classList.toggle('hidden', t!=='login');
            document.getElementById('form-register').classList.toggle('hidden', t!=='register');
            document.getElementById('tab-login').classList.toggle('active', t==='login');
            document.getElementById('tab-register').classList.toggle('active', t==='register');
        };
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
        
        window.showSection = (name) => {
            const sections = ['home', 'members', 'settings', 'ff', 'notifications'];
            sections.forEach(s => document.getElementById(`section-${s}`).classList.toggle('hidden', s !== name));
            document.getElementById('page-title').innerText = 
                name === 'home' ? 'ãƒ›ãƒ¼ãƒ ' : (name === 'members' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§' : (name === 'settings' ? 'ãƒ—ãƒ­ãƒ•è¨­å®š' : (name === 'ff' ? 'FFä¸€è¦§' : 'é€šçŸ¥')));
            
            if(name === 'members') loadUserList();
            if(name === 'ff') toggleFF('follower');
            if(name === 'notifications') loadNotifications();
            document.getElementById('sidebar').classList.remove('open');
        };

        // --- é€šçŸ¥ã‚’é€ã‚‹é–¢æ•° ---
        const addNotif = async (target, type, from, amount = 0) => {
            const notifRef = ref(db, `users/${target}/notifications`);
            const newNotif = push(notifRef);
            await set(newNotif, { type, from, amount, time: serverTimestamp() });
        };

        // --- é€šçŸ¥èª­ã¿è¾¼ã¿ ---
        const loadNotifications = async () => {
            const me = localStorage.getItem("loginnow");
            const snap = await get(ref(db, `users/${me}/notifications`));
            const area = document.getElementById('notif-list-area');
            area.innerHTML = "";
            if(snap.exists()){
                const data = Object.values(snap.val()).reverse(); // æ–°ã—ã„é †
                data.forEach(n => {
                    const div = document.createElement('div');
                    div.className = 'notif-item';
                    let msg = "";
                    if(n.type === 'tip') msg = `<b>${n.from}</b> ã•ã‚“ã‹ã‚‰ <b>${n.amount}pt</b> å±Šãã¾ã—ãŸï¼`;
                    if(n.type === 'follow') msg = `<b>${n.from}</b> ã•ã‚“ã«ãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚Œã¾ã—ãŸã€‚`;
                    div.innerHTML = `${msg}<div class="notif-time">${new Date(n.time).toLocaleString()}</div>`;
                    area.appendChild(div);
                });
            } else {
                area.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
            }
        };

        // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ ---
        const loadUserList = async () => {
            const snap = await get(ref(db, 'users'));
            const area = document.getElementById('user-list-area');
            area.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
            if(snap.exists()){
                area.innerHTML = "";
                Object.entries(snap.val()).forEach(([name, data]) => {
                    const card = document.createElement('a');
                    card.className = 'user-card';
                    card.href = "#" + encodeURIComponent(name);
                    card.onclick = () => setTimeout(() => location.reload(), 50);
                    card.innerHTML = `
                        <div class="user-icon small-icon">${data.icon ? `<img src="${data.icon}">` : 'ğŸ‘¤'}</div>
                        <div style="font-weight:bold; font-size:13px;">${name}</div>
                    `;
                    area.appendChild(card);
                });
            }
        };

        // --- FFä¸€è¦§ ---
        window.toggleFF = async (type) => {
            document.getElementById('tab-ff-follower').classList.toggle('active', type==='follower');
            document.getElementById('tab-ff-following').classList.toggle('active', type==='following');
            const me = localStorage.getItem("loginnow");
            const snap = await get(ref(db, 'users'));
            const area = document.getElementById('ff-list-area');
            area.innerHTML = "";
            if(snap.exists()){
                const all = snap.val();
                const myData = all[me];
                const list = (type === 'follower') ? (myData.followers ? Object.keys(myData.followers) : []) 
                                                   : (myData.following ? Object.keys(myData.following) : []);
                if(list.length === 0) return area.innerHTML = `<p style='grid-column:1/-1; text-align:center; color:#999;'>${type==='follower'?'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼':'ãƒ•ã‚©ãƒ­ãƒ¼'}ã¯ã„ã¾ã›ã‚“</p>`;
                
                list.forEach(name => {
                    const data = all[name];
                    const card = document.createElement('a');
                    card.className = 'user-card';
                    card.href = "#" + encodeURIComponent(name);
                    card.onclick = () => setTimeout(() => location.reload(), 50);
                    card.innerHTML = `<div class="user-icon small-icon">${data.icon ? `<img src="${data.icon}">` : 'ğŸ‘¤'}</div><div>${name}</div>`;
                    area.appendChild(card);
                });
            }
        };

        // --- è¨­å®šä¿å­˜ ---
        window.changeIcon = () => {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'image/*';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    await update(ref(db, `users/${localStorage.getItem("loginnow")}`), { icon: ev.target.result });
                    location.reload();
                };
                reader.readAsDataURL(e.target.files[0]);
            };
            input.click();
        };

        window.saveBio = async () => {
            const me = localStorage.getItem("loginnow");
            const bio = document.getElementById('settings-bio-input').value;
            await update(ref(db, `users/${me}`), { bio: bio });
            alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
        };

        // --- ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
        const init = async () => {
            const hash = decodeURIComponent(window.location.hash.substring(1));
            const me = localStorage.getItem("loginnow");

            if (hash) {
                const snap = await get(child(ref(db), `users/${hash}`));
                if (snap.exists()) {
                    const d = snap.val();
                    if (!sessionStorage.getItem('v_' + hash)) {
                        update(ref(db, `users/${hash}`), { views: increment(1) });
                        sessionStorage.setItem('v_' + hash, 'true');
                    }
                    document.getElementById('profile-view').style.display = 'block';
                    document.getElementById('view-name').innerText = hash;
                    document.getElementById('view-bio').innerText = d.bio || "è‡ªå·±ç´¹ä»‹ã¯ã‚ã‚Šã¾ã›ã‚“";
                    document.getElementById('view-count').innerText = d.views || 0;
                    document.getElementById('view-score').innerText = d.score || 0;
                    document.getElementById('view-followers').innerText = d.followers ? Object.keys(d.followers).length : 0;
                    if(d.icon) document.getElementById('view-icon').innerHTML = `<img src="${d.icon}">`;

                    const btnF = document.getElementById('btn-follow');
                    if(me && me !== hash){
                        const isF = d.followers && d.followers[me];
                        btnF.innerText = isF ? "ãƒ•ã‚©ãƒ­ãƒ¼è§£é™¤" : "ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹";
                        btnF.onclick = async () => {
                            const paths = { [`users/${hash}/followers/${me}`]: isF ? null : true, [`users/${me}/following/${hash}`]: isF ? null : true };
                            await update(ref(db), paths);
                            if(!isF) await addNotif(hash, 'follow', me);
                            location.reload();
                        };
                    } else btnF.classList.add('hidden');

                    document.getElementById('btn-tip').onclick = async () => {
                        const amt = parseInt(document.getElementById('tip-amount').value);
                        if(!me) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­");
                        if(isNaN(amt) || amt <= 0) return alert("æ•°ã‚’å…¥åŠ›ã—ã¦ã­");
                        const myS = await get(ref(db, `users/${me}`));
                        if(myS.val().score < amt) return alert("ãƒã‚¤ãƒ³ãƒˆä¸è¶³");
                        await update(ref(db, `users/${me}`), { score: increment(-amt) });
                        await update(ref(db, `users/${hash}`), { score: increment(amt) });
                        await addNotif(hash, 'tip', me, amt);
                        alert("é€ã‚Šã¾ã—ãŸï¼"); location.reload();
                    };
                    return;
                }
            }

            if (me) {
                const snap = await get(child(ref(db), `users/${me}`));
                if (snap.exists()) {
                    const d = snap.val();
                    document.getElementById('app-container').style.display = 'flex';
                    document.getElementById('disp-name').innerText = me;
                    document.getElementById('home-score').innerText = d.score || 0;
                    document.getElementById('settings-bio-input').value = d.bio || "";
                    if(d.icon) {
                        const img = `<img src="${d.icon}">`;
                        document.getElementById('side-icon').innerHTML = img;
                        document.getElementById('settings-icon-disp').innerHTML = img;
                    }
                    document.getElementById('share-url').innerText = window.location.origin + window.location.pathname + "#" + me;
                } else {
                    localStorage.removeItem("loginnow"); location.reload();
                }
            } else {
                document.getElementById('auth-container').style.display = 'block';
            }
        };

        init();

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²
        document.getElementById('btn-do-register').onclick = async () => {
            const id = document.getElementById('reg-username').value.trim();
            const pw = document.getElementById('reg-password').value.trim();
            if(!id || !pw) return;
            const snap = await get(child(ref(db), `users/${id}`));
            if(snap.exists()) return alert("æ—¢ã«å­˜åœ¨ã—ã¾ã™");
            await set(ref(db, 'users/'+id), { password:pw, score:0, views:0, bio:"" });
            localStorage.setItem("loginnow", id); location.reload();
        };

        document.getElementById('btn-do-login').onclick = async () => {
            const id = document.getElementById('login-username').value.trim();
            const pw = document.getElementById('login-password').value.trim();
            const snap = await get(child(ref(db), `users/${id}`));
            if(snap.exists() && snap.val().password === pw) {
                localStorage.setItem("loginnow", id); location.reload();
            } else alert("é–“é•ã„");
        };

        document.getElementById('btn-logout').onclick = () => {
            localStorage.removeItem("loginnow"); location.hash = ""; location.reload();
        };
    </script>
</body>
</html>
