<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>RTDB Login System</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        .hidden { display: none; }
        .score-info { color: blue; font-weight: bold; }
    </style>
</head>
<body>

    <h2>簡易RTDBログインシステム</h2>

    <div id="auth-ui" class="box">
        <input type="text" id="username" placeholder="ユーザーID（名前）"><br>
        <input type="password" id="password" placeholder="パスワード"><br><br>
        <button id="btn-register">新規登録</button>
        <button id="btn-login">ログイン</button>
    </div>

    <div id="menu-ui" class="box hidden">
        <h3>ようこそ <span id="disp-name"></span> さん</h3>
        <p class="score-info">現在のスコア: <span id="disp-score"></span></p>
        <p>開始日: <span id="disp-start"></span></p>
        <hr>
        <button id="btn-logout">ログアウト</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyCwhHspaG94goiCIjVj3h-Un5pBK3JTjMU",
            authDomain: "soulkin-aa3b7.firebaseapp.com",
            databaseURL: "https://soulkin-aa3b7-default-rtdb.firebaseio.com",
            projectId: "soulkin-aa3b7",
            storageBucket: "soulkin-aa3b7.firebasestorage.app",
            messagingSenderId: "358331064206",
            appId: "1:358331064206:web:d7760ea0919259418a4edf",
            measurementId: "G-S5Z8TTWYE2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ログイン状態を保持する簡易変数（リロードすると消えます）
        // ※永続化したい場合は localStorage.setItem('loginUser', ...) を使います
        let currentUser = null;

        // --- 1. 新規登録 ---
        document.getElementById('btn-register').onclick = async () => {
            const id = document.getElementById('username').value;
            const pw = document.getElementById('password').value;
            if(!id || !pw) return alert("入力してください");

            const userRef = ref(db, 'users/' + id);
            
            // 既にユーザーがいるか確認
            const snapshot = await get(userRef);
            if (snapshot.exists()) {
                alert("そのIDは既に使われています");
            } else {
                await set(userRef, {
                    password: pw,
                    score: 0,
                    startedAt: new Date().toLocaleDateString()
                });
                alert("登録完了！ログインしてください");
            }
        };

        // --- 2. ログイン（DBの中身をチェック） ---
        document.getElementById('btn-login').onclick = async () => {
            const id = document.getElementById('username').value;
            const pw = document.getElementById('password').value;

            const dbRef = ref(db);
            try {
                const snapshot = await get(child(dbRef, `users/${id}`));
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    if(userData.password === pw) {
                        showMenu(id, userData);
                    } else {
                        alert("パスワードが違います");
                    }
                } else {
                    alert("ユーザーが見つかりません");
                }
            } catch (e) { console.error(e); }
        };

        // UI切り替え
        function showMenu(id, data) {
            document.getElementById('auth-ui').classList.add('hidden');
            document.getElementById('menu-ui').classList.remove('hidden');
            document.getElementById('disp-name').innerText = id;
            document.getElementById('disp-score').innerText = data.score;
            document.getElementById('disp-start').innerText = data.startedAt;
        }

        // ログアウト
        document.getElementById('btn-logout').onclick = () => {
            location.reload(); // 簡易的にリロードで初期化
        };
    </script>
</body>
</html>
