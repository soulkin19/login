<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É¶„Éº„Ç∂„Éº„Éù„Éº„Çø„É´ v3</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; color: #333; }
        .hidden { display: none !important; }
        #auth-container { max-width: 400px; margin: 80px auto; background: #fff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .tab-menu { display: flex; background: #eee; }
        .tab-menu div { flex: 1; text-align: center; padding: 15px 0; cursor: pointer; font-weight: bold; color: #888; }
        .tab-menu div.active { background: #fff; color: #2196F3; border-bottom: 3px solid #2196F3; }
        .form-area { padding: 30px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; margin-bottom: 5px; color: #666; }
        .input-group input, .input-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        .action-btn { width: 100%; padding: 12px; background: #2196F3; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; }
        
        header { background: #2c3e50; color: #fff; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .hamburger-btn { font-size: 24px; cursor: pointer; }
        
        #sidebar { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background: #fff; box-shadow: 2px 0 10px rgba(0,0,0,0.2); transition: 0.3s ease; z-index: 1000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        #sidebar.open { left: 0; }
        .sidebar-close { text-align: right; font-size: 24px; cursor: pointer; color: #999; }
        
        .user-icon { width: 80px; height: 80px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 40px; margin: 0 auto 10px; overflow: hidden; border: 2px solid #2196F3; }
        .user-icon img { width: 100%; height: 100%; object-fit: cover; }
        
        /* „É¶„Éº„Ç∂„Éº‰∏ÄË¶ß„Ç´„Éº„Éâ */
        .user-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 20px; }
        .user-card { background: #fff; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; text-decoration: none; color: inherit; }
        .user-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .user-card .small-icon { width: 50px; height: 50px; font-size: 24px; margin-bottom: 8px; }

        /* „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫ */
        #profile-view { max-width: 500px; margin: 30px auto; background: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .bio-display { background: #f0f4f8; padding: 15px; border-radius: 10px; font-size: 14px; margin: 15px 0; text-align: left; white-space: pre-wrap; }
        .stats { display: flex; justify-content: space-around; margin: 20px 0; background: #f9f9f9; padding: 10px; border-radius: 10px; }
        .stats div { text-align: center; font-size: 12px; }
        .stats b { display: block; font-size: 18px; color: #2196F3; }
    </style>
</head>
<body>

    <div id="profile-view" class="hidden">
        <div class="user-icon" id="view-icon">üë§</div>
        <h2 id="view-name">„É¶„Éº„Ç∂„ÉºÂêç</h2>
        <button id="btn-follow" class="action-btn" style="width: auto; padding: 8px 20px; margin-bottom: 10px;">„Éï„Ç©„É≠„Éº„Åô„Çã</button>
        <div id="view-bio" class="bio-display"></div>
        <div class="stats">
            <div>üëÄ Èñ≤Ë¶ßÊï∞<b id="view-count">0</b></div>
            <div>üí∞ „Éù„Ç§„É≥„Éà<b id="view-score">0</b></div>
            <div>üë• „Éï„Ç©„É≠„ÉØ„Éº<b id="view-followers">0</b></div>
        </div>
        <button id="btn-tip" class="action-btn" style="background:#FF9800;">1pt ÂøúÊè¥„Åô„Çã</button>
        <a href="#" class="back-link" style="display:block; margin-top:20px; color:#2196F3;" onclick="location.hash=''; location.reload();">„Éõ„Éº„É†„Å∏Êàª„Çã</a>
    </div>

    <div id="auth-container">
        <div class="tab-menu">
            <div id="tab-login" class="active" onclick="switchTab('login')">„É≠„Ç∞„Ç§„É≥</div>
            <div id="tab-register" onclick="switchTab('register')">Êñ∞Ë¶è‰ΩúÊàê</div>
        </div>
        <div id="form-login" class="form-area">
            <div class="input-group"><label>„É¶„Éº„Ç∂„ÉºÂêç</label><input type="text" id="login-username"></div>
            <div class="input-group"><label>„Éë„Çπ„ÉØ„Éº„Éâ</label><input type="password" id="login-password"></div>
            <button class="action-btn" id="btn-do-login">„É≠„Ç∞„Ç§„É≥</button>
        </div>
        <div id="form-register" class="form-area hidden">
            <div class="input-group"><label>„É¶„Éº„Ç∂„ÉºÂêç</label><input type="text" id="reg-username"></div>
            <div class="input-group"><label>„Éë„Çπ„ÉØ„Éº„Éâ</label><input type="password" id="reg-password"></div>
            <button class="action-btn" id="btn-do-register" style="background:#34495e;">ÁôªÈå≤ÂÆå‰∫Ü</button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <header>
            <div class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</div>
            <div>Portal</div>
            <div style="width:24px;"></div>
        </header>
        <nav id="sidebar">
            <div class="sidebar-close" onclick="toggleSidebar()">√ó</div>
            <div class="user-icon" id="my-icon-display" onclick="changeIcon()" style="cursor:pointer;">üë§</div>
            <div class="input-group">
                <label>Ëá™Â∑±Á¥π‰ªã (100ÊñáÂ≠ó)</label>
                <textarea id="my-bio-input" rows="3" maxlength="100"></textarea>
                <button onclick="saveBio()" style="width:100%; margin-top:5px;">Êõ¥Êñ∞</button>
            </div>
            <div style="font-size:13px;">
                Âêç: <span id="disp-name"></span><br>
                PT: <span id="disp-score"></span><br>
                „Éï„Ç©„É≠„Éº‰∏≠: <span id="disp-following">0</span>
            </div>
            <button id="btn-logout" style="width:100%; padding:10px; background:#eee; border:none; border-radius:5px; margin-top:20px;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
        </nav>
        <main>
            <div style="padding:20px; text-align:center;">
                <h3>„É°„É≥„Éê„Éº‰∏ÄË¶ß</h3>
                <div id="user-list-area" class="user-list"></div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, update, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCwhHspaG94goiCIjVj3h-Un5pBK3JTjMU",
            authDomain: "soulkin-aa3b7.firebaseapp.com",
            databaseURL: "https://soulkin-aa3b7-default-rtdb.firebaseio.com",
            projectId: "soulkin-aa3b7",
            storageBucket: "soulkin-aa3b7.firebasestorage.app",
            messagingSenderId: "358331064206",
            appId: "1:358331064206:web:d7760ea0919259418a4edf"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- ÂÖ±ÈÄö ---
        window.switchTab = (t) => {
            document.getElementById('form-login').classList.toggle('hidden', t!=='login');
            document.getElementById('form-register').classList.toggle('hidden', t!=='register');
            document.getElementById('tab-login').classList.toggle('active', t==='login');
            document.getElementById('tab-register').classList.toggle('active', t==='register');
        };
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');

        // --- „É¶„Éº„Ç∂„Éº„É™„Çπ„Éà‰ΩúÊàê ---
        const loadUserList = async () => {
            const snap = await get(ref(db, 'users'));
            const area = document.getElementById('user-list-area');
            area.innerHTML = "";
            if(snap.exists()){
                Object.entries(snap.val()).forEach(([name, data]) => {
                    const card = document.createElement('a');
                    card.className = 'user-card';
                    card.href = "#" + name;
                    card.onclick = () => setTimeout(()=>location.reload(), 50);
                    card.innerHTML = `
                        <div class="user-icon small-icon">${data.icon ? `<img src="${data.icon}">` : 'üë§'}</div>
                        <div style="font-weight:bold; font-size:14px;">${name}</div>
                        <div style="font-size:10px; color:#999;">${data.score || 0} pt</div>
                    `;
                    area.appendChild(card);
                });
            }
        };

        // --- „Éó„É≠„Éï„Ç£„Éº„É´‰øùÂ≠òÁ≥ª ---
        window.saveBio = async () => {
            const me = localStorage.getItem("loginnow");
            await update(ref(db, `users/${me}`), { bio: document.getElementById('my-bio-input').value });
            alert("Êõ¥Êñ∞ÂÆå‰∫Ü");
        };

        window.changeIcon = () => {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file.size > 500000) return alert("500KB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    await update(ref(db, `users/${localStorage.getItem("loginnow")}`), { icon: ev.target.result });
                    location.reload();
                };
                reader.readAsDataURL(file);
            };
            input.click();
        };

        // --- „É°„Ç§„É≥Ë°®Á§∫ ---
        const init = async () => {
            const hash = decodeURIComponent(window.location.hash.substring(1));
            const me = localStorage.getItem("loginnow");

            if (hash) {
                const snap = await get(child(ref(db), `users/${hash}`));
                if (snap.exists()) {
                    const d = snap.val();
                    // Ë∂≥„ÅÇ„Å®Ôºã1
                    update(ref(db, `users/${hash}`), { views: increment(1) });
                    
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('profile-view').classList.remove('hidden');
                    document.getElementById('view-name').innerText = hash;
                    document.getElementById('view-bio').innerText = d.bio || "Ëá™Â∑±Á¥π‰ªã„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì";
                    document.getElementById('view-count').innerText = (d.views || 0) + 1;
                    document.getElementById('view-score').innerText = d.score || 0;
                    document.getElementById('view-followers').innerText = d.followers ? Object.keys(d.followers).length : 0;
                    if(d.icon) document.getElementById('view-icon').innerHTML = `<img src="${d.icon}">`;

                    // „ÉÅ„ÉÉ„ÉóÊ©üËÉΩ
                    document.getElementById('btn-tip').onclick = async () => {
                        if(!me) return alert("„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô");
                        if(me === hash) return alert("Ëá™ÂàÜ„Å´„ÅØÈÄÅ„Çå„Åæ„Åõ„Çì");
                        const mySnap = await get(ref(db, `users/${me}`));
                        if(mySnap.val().score < 1) return alert("„Éù„Ç§„É≥„Éà„ÅåË∂≥„Çä„Åæ„Åõ„Çì");
                        await update(ref(db, `users/${me}`), { score: increment(-1) });
                        await update(ref(db, `users/${hash}`), { score: increment(1) });
                        alert("1ptÈÄÅ„Çä„Åæ„Åó„ÅüÔºÅ"); location.reload();
                    };

                    // „Éï„Ç©„É≠„ÉºÊ©üËÉΩ
                    const btnF = document.getElementById('btn-follow');
                    if(me && me !== hash){
                        const isFollowing = d.followers && d.followers[me];
                        btnF.innerText = isFollowing ? "„Éï„Ç©„É≠„ÉºËß£Èô§" : "„Éï„Ç©„É≠„Éº„Åô„Çã";
                        btnF.onclick = async () => {
                            const pathF = `users/${hash}/followers/${me}`;
                            const pathM = `users/${me}/following/${hash}`;
                            if(isFollowing){
                                await update(ref(db), { [pathF]: null, [pathM]: null });
                            } else {
                                await update(ref(db), { [pathF]: true, [pathM]: true });
                            }
                            location.reload();
                        };
                    } else { btnF.classList.add('hidden'); }
                    return;
                }
            }

            if (me) {
                const snap = await get(child(ref(db), `users/${me}`));
                if (snap.exists()) {
                    const d = snap.val();
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('disp-name').innerText = me;
                    document.getElementById('welcome-name').innerText = me;
                    document.getElementById('disp-score').innerText = d.score || 0;
                    document.getElementById('disp-following').innerText = d.following ? Object.keys(d.following).length : 0;
                    document.getElementById('my-bio-input').value = d.bio || "";
                    if(d.icon) document.getElementById('my-icon-display').innerHTML = `<img src="${d.icon}">`;
                    loadUserList();
                }
            }
        };

        window.onload = init;

        // „É≠„Ç∞„Ç§„É≥„ÉªÁôªÈå≤„Éª„É≠„Ç∞„Ç¢„Ç¶„Éà
        document.getElementById('btn-do-register').onclick = async () => {
            const id = document.getElementById('reg-username').value.trim();
            const pw = document.getElementById('reg-password').value.trim();
            if(!id || !pw) return;
            const d = { password:pw, score:10, startedAt:new Date().toLocaleDateString(), views:0, bio:"" };
            await set(ref(db, 'users/'+id), d);
            localStorage.setItem("loginnow", id);
            location.reload();
        };
        document.getElementById('btn-do-login').onclick = async () => {
            const id = document.getElementById('login-username').value.trim();
            const pw = document.getElementById('login-password').value.trim();
            const snap = await get(child(ref(db), `users/${id}`));
            if(snap.exists() && snap.val().password === pw) {
                localStorage.setItem("loginnow", id);
                location.reload();
            } else alert("Â§±Êïó");
        };
        document.getElementById('btn-logout').onclick = () => {
            localStorage.removeItem("loginnow");
            location.hash = ""; location.reload();
        };
    </script>
</body>
</html>
