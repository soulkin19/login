<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É¶„Éº„Ç∂„Éº„Éù„Éº„Çø„É´</title>
    <style>
        /* --- Êó¢Â≠ò„Éá„Ç∂„Ç§„É≥Á∂≠ÊåÅ --- */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; color: #333; }
        .hidden { display: none !important; }
        #auth-container { max-width: 400px; margin: 80px auto; background: #fff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .tab-menu { display: flex; background: #eee; }
        .tab-menu div { flex: 1; text-align: center; padding: 15px 0; cursor: pointer; font-weight: bold; color: #888; transition: 0.3s; }
        .tab-menu div.active { background: #fff; color: #2196F3; border-bottom: 3px solid #2196F3; }
        .form-area { padding: 30px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 12px; margin-bottom: 5px; color: #666; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        .action-btn { width: 100%; padding: 12px; background: #2196F3; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        header { background: #2c3e50; color: #fff; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; }
        .hamburger-btn { font-size: 24px; cursor: pointer; user-select: none; }
        #sidebar { position: fixed; top: 0; left: -300px; width: 250px; height: 100%; background: #fff; box-shadow: 2px 0 10px rgba(0,0,0,0.2); transition: 0.3s ease-in-out; z-index: 1000; padding: 20px; box-sizing: border-box; }
        #sidebar.open { left: 0; }
        .profile-info { margin-bottom: 15px; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .profile-info span { font-weight: bold; float: right; }
        .user-icon { width: 80px; height: 80px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 40px; margin: 0 auto 15px; overflow: hidden; border: 2px solid #2196F3; }
        .user-icon img { width: 100%; height: 100%; object-fit: cover; }
        
        /* „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫Áî®„Çπ„Çø„Ç§„É´ */
        #profile-view { max-width: 500px; margin: 50px auto; background: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .back-link { display: block; margin-top: 20px; color: #2196F3; text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="tab-menu">
            <div id="tab-login" class="active" onclick="switchTab('login')">„É≠„Ç∞„Ç§„É≥</div>
            <div id="tab-register" onclick="switchTab('register')">Êñ∞Ë¶è‰ΩúÊàê</div>
        </div>
        <div id="form-login" class="form-area">
            <div class="input-group"><label>„É¶„Éº„Ç∂„ÉºÂêç</label><input type="text" id="login-username"></div>
            <div class="input-group"><label>„Éë„Çπ„ÉØ„Éº„Éâ</label><input type="password" id="login-password"></div>
            <button class="action-btn" id="btn-do-login">„É≠„Ç∞„Ç§„É≥</button>
            <div id="login-error" style="color:red; font-size:12px; margin-top:10px;"></div>
        </div>
        <div id="form-register" class="form-area hidden">
            <div class="input-group"><label>ÁôªÈå≤„É¶„Éº„Ç∂„ÉºÂêç</label><input type="text" id="reg-username"></div>
            <div class="input-group"><label>„Éë„Çπ„ÉØ„Éº„Éâ</label><input type="password" id="reg-password"></div>
            <button class="action-btn" id="btn-do-register" style="background:#34495e;">ÁôªÈå≤ÂÆå‰∫Ü</button>
        </div>
    </div>

    <div id="profile-view" class="hidden">
        <div class="user-icon" id="view-icon">üë§</div>
        <h2 id="view-name">„É¶„Éº„Ç∂„ÉºÂêç</h2>
        <div style="text-align: left; background: #f9f9f9; padding: 15px; border-radius: 10px;">
            <p>Ë≠òÂà•ID: <span id="view-uid"></span></p>
            <p>„Éù„Ç§„É≥„Éà: <span id="view-score"></span> pt</p>
            <p>ÁôªÈå≤Êó•: <span id="view-start"></span></p>
        </div>
        <a href="#" class="back-link" onclick="location.hash=''; location.reload();">„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å∏Êàª„Çã</a>
    </div>

    <div id="app-container" class="hidden">
        <header>
            <div class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</div>
            <div>Portal Dashboard</div>
            <div style="font-size: 12px;" id="my-link"></div>
        </header>
        <nav id="sidebar">
            <div class="user-icon" id="my-icon-display" onclick="changeIcon()" style="cursor:pointer;">üë§</div>
            <p style="text-align:center; font-size:12px; color:#666;">„Ç¢„Ç§„Ç≥„É≥„Çí„Çø„ÉÉ„Éó„ÅßÂ§âÊõ¥</p>
            <h3>Ë®≠ÂÆö</h3>
            <div class="profile-info">Ê∞èÂêç: <span id="disp-name"></span></div>
            <div class="profile-info">ID: <span id="disp-uid" style="font-size: 10px;"></span></div>
            <div class="profile-info">„Éù„Ç§„É≥„Éà: <span id="disp-score"></span></div>
            <button id="btn-logout" style="width:100%; padding:10px; background:#95a5a6; color:white; border:none; border-radius:5px;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
        </nav>
        <main style="padding:40px; text-align:center;">
            <h1>„Åì„Çì„Å´„Å°„ÅØ„ÄÅ<span id="welcome-name"></span>„Åï„Çì</h1>
            <p>„ÅÇ„Å™„Åü„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´URL:<br>
            <code id="share-url" style="background:#eee; padding:5px;"></code></p>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCwhHspaG94goiCIjVj3h-Un5pBK3JTjMU",
            authDomain: "soulkin-aa3b7.firebaseapp.com",
            databaseURL: "https://soulkin-aa3b7-default-rtdb.firebaseio.com",
            projectId: "soulkin-aa3b7",
            storageBucket: "soulkin-aa3b7.firebasestorage.app",
            messagingSenderId: "358331064206",
            appId: "1:358331064206:web:d7760ea0919259418a4edf",
            measurementId: "G-S5Z8TTWYE2"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const generateUniqueId = () => 'ID-' + Math.random().toString(36).substr(2, 9).toUpperCase();

        // --- „Ç¢„Ç§„Ç≥„É≥Ë®≠ÂÆö (Ë∂ÖËªΩÈáè: Base64ÂΩ¢Âºè) ---
        window.changeIcon = async () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file.size > 500000) return alert("ÁîªÂÉè„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô(50KB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ)");
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const base64Img = event.target.result;
                    const username = localStorage.getItem("loginnow");
                    await update(ref(db, `users/${username}`), { icon: base64Img });
                    location.reload();
                };
                reader.readAsDataURL(file);
            };
            input.click();
        };

        // --- Ë°®Á§∫Âá¶ÁêÜ ---
        const showApp = (username, userData) => {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('disp-name').innerText = username;
            document.getElementById('welcome-name').innerText = username;
            document.getElementById('disp-uid').innerText = userData.uniqueId;
            document.getElementById('disp-score').innerText = userData.score;
            if(userData.icon) document.getElementById('my-icon-display').innerHTML = `<img src="${userData.icon}">`;
            
            const url = window.location.href.split('#')[0] + '#' + username;
            document.getElementById('share-url').innerText = url;
        };

        // --- URL„Éè„ÉÉ„Ç∑„É•Ê§úÁü• (#ÂêçÂâç „ÅÆÂá¶ÁêÜ) ---
        const checkHashAndLogin = async () => {
            const hash = decodeURIComponent(window.location.hash.substring(1));
            if (hash) {
                // ‰ªñ‰∫∫„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„ÇíË°®Á§∫
                const snapshot = await get(child(ref(db), `users/${hash}`));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('profile-view').classList.remove('hidden');
                    document.getElementById('view-name').innerText = hash;
                    document.getElementById('view-uid').innerText = data.uniqueId;
                    document.getElementById('view-score').innerText = data.score;
                    document.getElementById('view-start').innerText = data.startedAt;
                    if(data.icon) document.getElementById('view-icon').innerHTML = `<img src="${data.icon}">`;
                    return; 
                }
            }
            
            // ÈÄöÂ∏∏„ÅÆ„É≠„Ç∞„Ç§„É≥„ÉÅ„Çß„ÉÉ„ÇØ
            const savedUser = localStorage.getItem("loginnow");
            if (savedUser) {
                const snapshot = await get(child(ref(db), `users/${savedUser}`));
                if (snapshot.exists()) showApp(savedUser, snapshot.val());
            }
        };

        window.onload = checkHashAndLogin;

        // „É≠„Ç∞„Ç§„É≥„ÉªÁôªÈå≤„Éª„Çø„ÉñÂàáÊõø„Éª„Çµ„Ç§„Éâ„Éê„Éº (Êó¢Â≠ò„É≠„Ç∏„ÉÉ„ÇØ)
        window.switchTab = (tab) => {
            document.getElementById('tab-login').classList.toggle('active', tab === 'login');
            document.getElementById('tab-register').classList.toggle('active', tab === 'register');
            document.getElementById('form-login').classList.toggle('hidden', tab !== 'login');
            document.getElementById('form-register').classList.toggle('hidden', tab !== 'register');
        };
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');

        document.getElementById('btn-do-register').onclick = async () => {
            const id = document.getElementById('reg-username').value.trim();
            const pw = document.getElementById('reg-password').value.trim();
            if (!id || !pw) return;
            const data = { uniqueId: generateUniqueId(), password: pw, score: 0, startedAt: new Date().toLocaleDateString(), icon: "" };
            await set(ref(db, 'users/' + id), data);
            localStorage.setItem("loginnow", id);
            showApp(id, data);
        };

        document.getElementById('btn-do-login').onclick = async () => {
            const id = document.getElementById('login-username').value.trim();
            const pw = document.getElementById('login-password').value.trim();
            const snapshot = await get(child(ref(db), `users/${id}`));
            if (snapshot.exists() && snapshot.val().password === pw) {
                localStorage.setItem("loginnow", id);
                showApp(id, snapshot.val());
            } else {
                document.getElementById('login-error').innerText = "„É≠„Ç∞„Ç§„É≥Â§±Êïó";
            }
        };

        document.getElementById('btn-logout').onclick = () => {
            localStorage.removeItem("loginnow");
            location.hash = "";
            location.reload();
        };
    </script>
</body>
</html>
