<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ユーザーポータル</title>
    <style>
        /* --- デザイン（変更なし） --- */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; color: #333; }
        .hidden { display: none !important; }

        #auth-container { max-width: 400px; margin: 80px auto; background: #fff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .tab-menu { display: flex; background: #eee; }
        .tab-menu div { flex: 1; text-align: center; padding: 15px 0; cursor: pointer; font-weight: bold; color: #888; transition: 0.3s; }
        .tab-menu div.active { background: #fff; color: #2196F3; border-bottom: 3px solid #2196F3; }
        .form-area { padding: 30px; }
        .form-area h2 { margin-top: 0; text-align: center; color: #444; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 12px; margin-bottom: 5px; color: #666; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        .action-btn { width: 100%; padding: 12px; background: #2196F3; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .action-btn:hover { background: #1976D2; }
        .error-msg { color: #e74c3c; font-size: 13px; text-align: center; margin-top: 10px; min-height: 15px; }

        header { background: #2c3e50; color: #fff; padding: 15px 20px; display: flex; align-items: center; }
        .hamburger-btn { font-size: 24px; cursor: pointer; margin-right: 15px; user-select: none; }
        
        #sidebar { position: fixed; top: 0; left: -300px; width: 250px; height: 100%; background: #fff; box-shadow: 2px 0 10px rgba(0,0,0,0.2); transition: 0.3s ease-in-out; z-index: 1000; padding: 20px; box-sizing: border-box; }
        #sidebar.open { left: 0; }
        #sidebar h3 { margin-top: 0; color: #2196F3; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .profile-info { margin-bottom: 15px; font-size: 14px; }
        .profile-info span { font-weight: bold; color: #333; float: right; }
        .close-btn { text-align: right; cursor: pointer; color: #999; font-size: 20px; margin-bottom: 10px; }
        #btn-logout { width: 100%; padding: 10px; background: #95a5a6; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; }

        .main-content { padding: 40px; text-align: center; }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="tab-menu">
            <div id="tab-login" class="active" onclick="switchTab('login')">ログイン</div>
            <div id="tab-register" onclick="switchTab('register')">新規作成</div>
        </div>
        <div id="form-login" class="form-area">
            <h2>ログイン</h2>
            <div class="input-group">
                <label>ユーザー名</label>
                <input type="text" id="login-username" placeholder="ユーザーID">
            </div>
            <div class="input-group">
                <label>パスワード</label>
                <input type="password" id="login-password" placeholder="••••••••">
            </div>
            <button class="action-btn" id="btn-do-login">ログイン</button>
            <div class="error-msg" id="login-error"></div>
        </div>
        <div id="form-register" class="form-area hidden">
            <h2>新規ユーザー登録</h2>
            <div class="input-group">
                <label>登録ユーザー名</label>
                <input type="text" id="reg-username" placeholder="例: yamada_taro">
            </div>
            <div class="input-group">
                <label>パスワード</label>
                <input type="password" id="reg-password" placeholder="••••••••">
            </div>
            <button class="action-btn" id="btn-do-register" style="background: #34495e;">登録を完了する</button>
            <div class="error-msg" id="reg-error"></div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <header>
            <div class="hamburger-btn" onclick="toggleSidebar()">☰</div>
            <h2>Portal Dashboard</h2>
        </header>
        <nav id="sidebar">
            <div class="close-btn" onclick="toggleSidebar()">✖</div>
            <h3>アカウント設定</h3>
            <div class="profile-info">氏名: <span id="disp-name"></span></div>
            <div class="profile-info">個別識別ID: <span id="disp-uid" style="font-size: 11px; color: #7f8c8d;"></span></div>
            <div class="profile-info">保有ポイント: <span id="disp-score"></span> pt</div>
            <div class="profile-info">登録日: <span id="disp-start"></span></div>
            <button id="btn-logout">ログアウト</button>
        </nav>
        <main class="main-content">
            <h1>こんにちは、<span id="welcome-name"></span>さん</h1>
            <p>本日のダッシュボードへようこそ。</p>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCwhHspaG94goiCIjVj3h-Un5pBK3JTjMU",
            authDomain: "soulkin-aa3b7.firebaseapp.com",
            databaseURL: "https://soulkin-aa3b7-default-rtdb.firebaseio.com",
            projectId: "soulkin-aa3b7",
            storageBucket: "soulkin-aa3b7.firebasestorage.app",
            messagingSenderId: "358331064206",
            appId: "1:358331064206:web:d7760ea0919259418a4edf",
            measurementId: "G-S5Z8TTWYE2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 1. クッキー操作関数 ---
        const setCookie = (name, value, days = 30) => {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
        };

        const getCookie = (name) => {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i=0;i < ca.length;i++) {
                let c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        };

        const deleteCookie = (name) => {
            document.cookie = name + '=; Max-Age=-99999999; path=/;';
        };

        // --- 2. ID生成 ---
        const generateUniqueId = () => 'ID-' + Math.random().toString(36).substr(2, 9).toUpperCase();

        // --- 3. UI表示制御 ---
        window.switchTab = (tab) => {
            document.getElementById('tab-login').classList.toggle('active', tab === 'login');
            document.getElementById('tab-register').classList.toggle('active', tab === 'register');
            document.getElementById('form-login').classList.toggle('hidden', tab !== 'login');
            document.getElementById('form-register').classList.toggle('hidden', tab !== 'register');
        };
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');

        const showApp = (username, userData) => {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('disp-name').innerText = username;
            document.getElementById('welcome-name').innerText = username;
            document.getElementById('disp-uid').innerText = userData.uniqueId;
            document.getElementById('disp-score').innerText = userData.score;
            document.getElementById('disp-start').innerText = userData.startedAt;
        };

        // ★★★ 4. クッキーを検知する仕組み（自動ログイン） ★★★
        // ページ読み込み時に即座に実行される
        const checkLoginStatus = async () => {
            const savedUser = getCookie("loginnow"); // クッキーから名前を取得
            if (savedUser) {
                console.log("Cookie検知:", savedUser);
                const snapshot = await get(child(ref(db), `users/${savedUser}`));
                if (snapshot.exists()) {
                    showApp(savedUser, snapshot.val());
                } else {
                    deleteCookie("loginnow"); // DBにデータがなければクッキーを掃除
                }
            }
        };
        checkLoginStatus(); // 実行

        // --- 5. 登録・ログイン処理 ---
        document.getElementById('btn-do-register').onclick = async () => {
            const id = document.getElementById('reg-username').value.trim();
            const pw = document.getElementById('reg-password').value.trim();
            if (!id || !pw) return;

            const userRef = ref(db, 'users/' + id);
            const snapshot = await get(userRef);
            if (snapshot.exists()) {
                document.getElementById('reg-error').innerText = "既に存在します";
            } else {
                const data = { uniqueId: generateUniqueId(), password: pw, score: 0, startedAt: new Date().toLocaleDateString() };
                await set(userRef, data);
                setCookie("loginnow", id); // 登録時にクッキー保存
                showApp(id, data);
            }
        };

        document.getElementById('btn-do-login').onclick = async () => {
            const id = document.getElementById('login-username').value.trim();
            const pw = document.getElementById('login-password').value.trim();
            const snapshot = await get(child(ref(db), `users/${id}`));
            if (snapshot.exists() && snapshot.val().password === pw) {
                setCookie("loginnow", id); // ログイン時にクッキー保存
                showApp(id, snapshot.val());
            } else {
                document.getElementById('login-error').innerText = "失敗しました";
            }
        };

        document.getElementById('btn-logout').onclick = () => {
            deleteCookie("loginnow"); // クッキー削除
            location.reload();
        };
    </script>
</body>
</html>
